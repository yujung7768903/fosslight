<%@ page contentType="text/html; charset=utf-8" pageEncoding="utf-8"%>
<%@ include file="/WEB-INF/constants.jsp"%>
<script type="text/javascript">
var existTooltip = false;
var initYn = true;
var totalRow = 0;
var _popupVuln = null;
const G_ROW_CNT = "${ct:getCodeExpString(ct:getConstDef('CD_EXCEL_DOWNLOAD'), ct:getConstDef('CD_MAX_ROW_COUNT'))}";
$(document).ready(function () {
	'use strict';
	setMaxRowCnt(G_ROW_CNT); // maxRowCnt 값 setting
	
	var _defaultSearchOss = "${defaultOssName}";

	if(_defaultSearchOss) {
		$("#product").val(_defaultSearchOss);
	}

	var _defaultSearchVer = "${defaultOssVersion}";

	if(_defaultSearchVer) {
		$("#version").val(_defaultSearchVer);
	}
	
	evt.init();
	list.load();
	initYn = false;	

	AutoCompleteInit();

	$("#version").focus(function(){
		var product = $("#product").val();
		
		if(product != ''){
			VersionAutoComplete(product);
		}
	});
	
	showHelpLink("Vulnerability_List_Main");
});

// event
var evt = {
	init : function(){
		$('#search').on('click',function(e) {
			e.preventDefault();
			
			var postData=$('#vulnerabilitySearch').serializeObject();
			
			if(initYn) {
				list.load({
			        product:$("#product").val(), version:$("#version").val()
			    });
			    
				initYn = false;
			} else {
				var _url = '<c:url value="/vulnerability/listAjax"/>';
				$("#list").jqGrid('setGridParam', {postData : postData, page : 1, url : _url}).trigger('reloadGrid');
			}
		});

		$("#ossNameAllSearchFlag").on("click", function(e) {
			$("[name='ossNameAllSearchFlag']").val($(this).prop("checked") ? "Y" : "N");
		});
	}
};	

var list = {
	sortOrder : "",
	load : function(){
		$("#list").jqGrid({
			datatype: "json",
			jsonReader:{
				repeatitems: false,
				root:function(obj){return obj.rows;},
				page:function(obj){return obj.page;},
				total:function(obj){return obj.total;},
				records:function(obj){
					if(obj.rows.length > 0) {
						list.sortOrder = obj.rows[0].sortOrder;
						
						if(list.sortOrder == "" || list.sortOrder == "asc") {
							list.sortOrder == "desc";
						} else {
							list.sortOrder == "asc";
						}
					}
					
					return obj.records;
				}
			},
			colNames: ['OSS Name', 'Nickname', 'OSS Version', 'Max CVSS Score'],
			colModel: [
				{name: 'product', index: 'product', width: 200, align: 'left', template: searchStringOptions, formatter:displayLinkProduct, unformatter:unDisplayLinkTitle
					, cellattr: function(rowId, tv, rowObject, cm, rdata) {
						var titleMsg = '';
						
						if(rowObject.product != ''){
							titleMsg = 'Show all CVE ID of the corresponding OSS and version.';
						}
						
						return ' title="'+titleMsg+'"';
					}
				},
				{name: 'ossNickname', index: 'ossNickname', width: 200, align: 'left', template: searchStringOptions, formatter:displayLinkNickName, unformatter:unDisplayLinkTitle
					, cellattr: function(rowId, tv, rowObject, cm, rdata) {
						var titleMsg = '';
						
						if(rowObject.nickname != ''){
							titleMsg = 'Show all CVE ID of the corresponding OSS and version.';
						}
						
						return ' title="'+titleMsg+'"';
					}
				},
				{name: 'version', index: 'version', width: 100, align: 'left', template: searchStringOptions},
				{name: 'cvssScore', index: 'cvssScore', width: 100, align: 'center', formatter:displayVulnerability, unformatter:unformatter, template: searchNumberOptions}
			],
			rownumbers: true,
			rownumWidth:35,
			rowNum: ${ct:getConstDef("DISP_PAGENATION_DEFAULT")},
			rowList: [${ct:getConstDef("DISP_PAGENATION_LIST_STR")}],
			autowidth: true,
			pager: '#pager',
			gridview: true,
			sortable: function (permutation) {},
			sortname: 'product',
			viewrecords: true,
			sortorder: 'desc',
			height: 'auto',
			loadonce: false,
			onSortCol: function(col){
				list.load({sortField : col, sortOrder : list.sortOrder})
			},	// 헤더 정렬 클릭시
			beforeRequest: function(){
				var postData =$("#list").jqGrid('getGridParam','postData');
				var data = $('#vulnerabilitySearch').serializeObject();

				if(data.product){
					postData.product = data.product;
				}
				
				if(data.vulnSummary){
					postData.vulnSummary = data.vulnSummary;
				}
				if(data.version){
					postData.version = data.version;
				}
				
				if(data.cveId){
					postData.cveId = data.cveId;
				}
			},
			gridComplete: function(data) {
				var reccount = $("#list").getGridParam("reccount");
				if(reccount == 0) {
					var postData =$("#list").jqGrid('getGridParam','postData');
					if(postData.cveId != "") {
	 					$.ajax({
	 						url :'<c:url value="/vulnerability/checkCveId"/>',
	 			            type : 'GET',
	 			            data : {"cveId":postData.cveId},
	 			            dataType:"json",
	 			            cache : false,
	 				        success : function(json){
		 				        var cveInfo = json;
		 				        if(cveInfo != null){
		 				        	var msg = "<ul>";
		 				        	var baseScore = cveInfo.CVSS_SCORE;
		 				        	if(baseScore == 0) {
		 				        		baseScore = "NA";
		 				        		msg += "<li><b>NVD score not yet provided.</b></li>";
		 				        	}
		 				        	msg += "<li>" + "<a href='https://web.nvd.nist.gov/view/vuln/detail?vulnId="+cveInfo.CVE_ID+"' class='urlLink' target='_blank'>"+cveInfo.CVE_ID+"</a>" + "</li>";
		 				        	msg += "<li><b>Base Score</b> : " + baseScore + "</li>";
		 				        	msg += "<li><b>Last Modified</b> : " + cveInfo.MODI_DATE + "</li>";
		 				        	msg += "<li><b>Description</b> : <br>" + cveInfo.VULN_SUMMARY + "</li>";
		 				        	alertify.alert(msg, function(){});
			 				    }
	 				        },
	 			            error : function(){
	 			            }
	 					});
					}
				}
				
			},
			loadComplete: function(data) {
				totalRow = data.records;
				if(!existTooltip) {
					$.ajax({
						type: 'GET',
						url: '<c:url value="/system/processGuide/getProcessGuide"/>',
						data: {"id":"Vulnerability_NVD_Score"},
						success : function(data){
							if(data.processGuide){
								var contents = data.processGuide.contents;
								
								if(contents && contents.trim()) {
									
									$('<span class="iconSet help right">Help</span>').appendTo($("#jqgh_list_cvssScore"))
										.attr("title", contents).tooltip({
											content: function () {
												return $(this).prop('title');
											}
										});
								}
							}
						}
					});
				}
				
				existTooltip = true;
			}
		});
		
		$("#list").jqGrid('filterToolbar',{stringResult: true, searchOnEnter: true, searchOperators: true, defaultSearch: "cn"});
	}
}

function AutoCompleteInit(){
	$.ajax({
		url: '<c:url value="/vulnerability/AutoCompleteAjax"/>',
		datatype: "json",
		success: function(obj){
			var OSSName = [];
			var CveId = [];
			
			$.each(obj.nameList,function(index,value){ OSSName.push(value); });
			$.each(obj.cveIdList,function(index,value){ CveId.push(value); });
			
			$(".autoComVulnerabilityOSS").autocomplete({source: OSSName, minLength: 3});
			$(".autoComCveId").autocomplete({source: CveId, minLength: 3});
		}
	});
}

function VersionAutoComplete(product){
	$.ajax({
		url: '<c:url value="/vulnerability/VersionAutoCompleteAjax"/>',
		data : {product : product},
		datatype: "json",
		success: function(obj){
			var OSSVersion = [];
			$.each(obj,function(index,value){ 
				OSSVersion.push(value); 
			});
			
			$(".autoComVulnerabilityOSSVersion").autocomplete({source: OSSVersion});
		}
	});
}


function displayVulnerability(cellvalue, options, rowObject){
	var display = "";
	
	if(parseInt(cellvalue) >= 9.0) {
		display="<span class=\"iconSet vulCritical\">"+cellvalue+"</span>";
	} else if(parseInt(cellvalue) >= 7.0) {
		display="<span class=\"iconSet vulHigh\">"+cellvalue+"</span>";
	} else if(parseInt(cellvalue) >= 4.0) {
		display="<span class=\"iconSet vulMiddle\">"+cellvalue+"</span>";
	} else if(parseInt(cellvalue) > 0) {
		display="<span class=\"iconSet vulLow\">"+cellvalue+"</span>";
	} else {
		display="<span style=\"font-size:0;\"></span>";
	}
	
	return display;
}

function displayLinkProduct(cellvalue, options, rowObject){
	var product = rowObject.product.split("\\").join("\\\\");
	var version = rowObject.version.split("\\").join("\\\\");
	
	return '<a href=\'#\' onclick=\'javascript:showVulnViewPage(\"'+encodeURIComponent(product)+'\",\"'+encodeURIComponent(version)+'\")\' class=\'urlLink\'>'+cellvalue+'</a>';
}

function displayLinkNickName(cellvalue, options, rowObject){
	var tag = "";
	if(rowObject.ossNickname) {
		var nickname = rowObject.ossNickname.split(",");
		for(var i in nickname){
			var nick = nickname[i].split("\\").join("\\\\");
			var version = rowObject.version.split("\\").join("\\\\");
			
			tag += '<a href=\'#\' onclick=\'javascript:showVulnViewPage(\"'+encodeURIComponent(nick)+'\",\"'+encodeURIComponent(version)+'\")\' class=\'urlLink\' style="display: inline;">'+nickname[i]+'</a>&nbsp;';
		}		
	}
	
	return tag;
}

function unDisplayLinkTitle(cellvalue, options, rowObject){
	return cellvalue;
}

function showVulnViewPage(_ossName, _ossVersion){
	var _url = '<c:url value="/vulnerability/vulnpopup?ossName='+_ossName+'&ossVersion='+_ossVersion+'"/>';// +"&isPopup=Y"; // 사용하지 않는 parameter
	
	if(_popupVuln == null || _popupVuln.closed) {
		_popupVuln = window.open(_url, "vulnViewPopup_"+_ossName, "width=950, height=600, toolbar=no, location=no, left=100, top=100");

		if(!_popupVuln || _popupVuln.closed || typeof _popupVuln.closed=='undefined') {
			alertify.alert('<spring:message code="msg.common.window.allowpopup" />', function(){});
		}
	} else {
		_popupVuln.close();
		
		_popupVuln = window.open(_url, "vulnViewPopup_"+_ossName, "width=900, height=600, toolbar=no, location=no, left=100, top=100");
	}
}

function unformatter(cellvalue, options, rowObject){
	return cellvalue;
}

/* 2018-07-26 choye 추가 */
function downloadExcel(){
	if(isMaximumRowCheck(totalRow)){
		var postData =$("#list").jqGrid('getGridParam','postData');
		var data = $('#vulnerabilitySearch').serializeObject();
		data.filters = postData.filters;
	
		$.ajax({
			type: "POST",
			url: '<c:url value="/exceldownload/getExcelPost"/>',
			data: JSON.stringify({"type":"vulnerability", "parameter":JSON.stringify(data)}),
			dataType : 'json',
			cache : false,
			contentType : 'application/json',
			success: function (data) {
				if("false" == data.isValid) {
					if(data.validMsg == "overflow") {
					 alertify.error(getMsgMaxRowCnt(), 0);
					} else {
					 	alertify.error('<spring:message code="msg.common.valid2" />', 0);
					}
				} else {
					window.location =  '<c:url value="/exceldownload/getFile?id='+data.validMsg+'"/>';
				}
			},
			error: function(data){
				alertify.error('<spring:message code="msg.common.valid2" />', 0);
			}
		});
	}
}
</script>